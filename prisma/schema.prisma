generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String             @id @default(uuid())
  email              String             @unique
  phone              String?            @unique
  firstName          String
  lastName           String
  avatarUrl          String?
  dateOfBirth        DateTime?
  role               UserRole           @default(RENTER)
  drivingLicenseNo   String?
  drivingLicenseExp  DateTime?
  drivingLicenseUrl  String?
  idNumber           String?
  idDocumentUrl      String?
  isEmailVerified    Boolean            @default(false)
  isPhoneVerified    Boolean            @default(false)
  isIdVerified       Boolean            @default(false)
  isLicenseVerified  Boolean            @default(false)
  verificationStatus VerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verifiedBy         String?
  bankName           String?
  bankAccountNumber  String?
  bankAccountName    String?
  bio                String?
  responseRate       Float?             @default(0)
  responseTime       String?
  isActive           Boolean            @default(true)
  isBanned           Boolean            @default(false)
  banReason          String?
  bannedAt           DateTime?
  bannedBy           String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  activeProfileMode  UserRole?
  isSeedData         Boolean            @default(false)
  adminLogs          AdminLog[]         @relation("AdminLogs")
  bookingsAsRenter   Booking[]          @relation("RenterBookings")
  cars               Car[]
  favorites          Favorite[]
  receivedMessages   Message[]          @relation("ReceivedMessages")
  sentMessages       Message[]          @relation("SentMessages")
  notifications      Notification[]
  paymentMethods     PaymentMethod[]
  payouts            Payout[]
  reviewsReceived    Review[]           @relation("RevieweeReviews")
  reviewsGiven       Review[]           @relation("ReviewerReviews")
  reportsMade        Report[]           @relation("ReportedBy")

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([verificationStatus])
}

model Car {
  id              String         @id @default(uuid())
  ownerId         String
  make            String
  model           String
  year            Int
  licensePlate    String         @unique
  vin             String?        @unique
  color           String
  transmission    Transmission   @default(AUTOMATIC)
  fuelType        FuelType       @default(PETROL)
  seats           Int            @default(5)
  doors           Int            @default(4)
  category        CarCategory    @default(SEDAN)
  features        String[]
  hasAC           Boolean        @default(true)
  hasGPS          Boolean        @default(false)
  hasUSB          Boolean        @default(true)
  hasBluetooth    Boolean        @default(true)
  hasChildSeat    Boolean        @default(false)
  city            String         @default("Tbilisi")
  address         String
  latitude        Float
  longitude       Float
  pricePerDay     Float
  pricePerHour    Float?
  securityDeposit Float          @default(200)
  minRentalDays   Int            @default(1)
  maxRentalDays   Int            @default(30)
  mileageLimit    Int?
  extraMileageFee Float?
  currentMileage  Int            @default(0)
  status          CarStatus      @default(PENDING)
  isActive        Boolean        @default(true)
  isInstantBook   Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  isSeedData      Boolean        @default(false)
  availabilities  Availability[]
  bookings        Booking[]
  owner           User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  images          CarImage[]
  favorites       Favorite[]
  reviews         Review[]

  @@index([ownerId])
  @@index([city])
  @@index([status])
  @@index([category])
  @@index([pricePerDay])
  @@index([make, model])
}

model CarImage {
  id        String   @id @default(uuid())
  carId     String
  url       String
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
}

model Availability {
  id          String   @id @default(uuid())
  carId       String
  startDate   DateTime
  endDate     DateTime
  isBlocked   Boolean  @default(false)
  pricePerDay Float?
  car         Car      @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@index([carId])
  @@index([startDate, endDate])
}

model Booking {
  id                 String        @id @default(uuid())
  carId              String
  renterId           String
  startDate          DateTime
  endDate            DateTime
  actualStartDate    DateTime?
  actualEndDate      DateTime?
  pickupLocation     String
  pickupLat          Float?
  pickupLng          Float?
  returnLocation     String?
  returnLat          Float?
  returnLng          Float?
  startMileage       Int?
  endMileage         Int?
  dailyRate          Float
  totalDays          Int
  subtotal           Float
  serviceFee         Float
  insuranceFee       Float?
  extraMileageFee    Float?
  lateFee            Float?
  totalAmount        Float
  securityDeposit    Float
  status             BookingStatus @default(PENDING)
  paymentStatus      PaymentStatus @default(PENDING)
  flittPaymentId     String?
  paidAt             DateTime?
  cancelledAt        DateTime?
  cancelledBy        String?
  cancellationReason String?
  refundAmount       Float?
  renterNote         String?
  hostNote           String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  isSeedData         Boolean       @default(false)
  car                Car           @relation(fields: [carId], references: [id])
  renter             User          @relation("RenterBookings", fields: [renterId], references: [id])
  messages           Message[]
  payments           Payment[]
  review             Review?

  @@index([carId])
  @@index([renterId])
  @@index([status])
  @@index([startDate, endDate])
}

model Payment {
  id             String        @id @default(uuid())
  bookingId      String
  amount         Float
  currency       String        @default("GEL")
  type           PaymentType
  status         PaymentStatus @default(PENDING)
  flittPaymentId String?
  flittRefundId  String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  booking        Booking       @relation(fields: [bookingId], references: [id])

  @@index([bookingId])
}

model PaymentMethod {
  id             String   @id @default(uuid())
  userId         String
  type           String
  flittCardToken String?
  last4          String
  brand          String?
  expiryMonth    Int?
  expiryYear     Int?
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Payout {
  id              String       @id @default(uuid())
  userId          String
  amount          Float
  currency        String       @default("GEL")
  status          PayoutStatus @default(PENDING)
  bankName        String?
  accountNumber   String?
  flittTransferId String?
  processedAt     DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  user            User         @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Review {
  id            String     @id @default(uuid())
  bookingId     String     @unique
  carId         String
  reviewerId    String
  revieweeId    String
  type          ReviewType
  rating        Int
  cleanliness   Int?
  communication Int?
  accuracy      Int?
  value         Int?
  comment       String?
  hostResponse  String?
  respondedAt   DateTime?
  isPublic      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  booking       Booking    @relation(fields: [bookingId], references: [id])
  car           Car        @relation(fields: [carId], references: [id])
  reviewee      User       @relation("RevieweeReviews", fields: [revieweeId], references: [id])
  reviewer      User       @relation("ReviewerReviews", fields: [reviewerId], references: [id])

  @@index([carId])
  @@index([reviewerId])
  @@index([revieweeId])
}

model Message {
  id         String    @id @default(uuid())
  bookingId  String?
  senderId   String
  receiverId String
  content    String
  imageUrl   String?
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())
  booking    Booking?  @relation(fields: [bookingId], references: [id])
  receiver   User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User      @relation("SentMessages", fields: [senderId], references: [id])

  @@index([bookingId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  carId     String
  createdAt DateTime @default(now())
  car       Car      @relation(fields: [carId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, carId])
  @@index([userId])
  @@index([carId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model AdminLog {
  id         String      @id @default(uuid())
  adminId    String
  action     AdminAction
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  reason     String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())
  admin      User        @relation("AdminLogs", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum UserRole {
  RENTER
  OWNER
  ADMIN
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum AdminAction {
  USER_VERIFIED
  USER_REJECTED
  USER_BANNED
  USER_UNBANNED
  USER_ROLE_CHANGED
  CAR_APPROVED
  CAR_REJECTED
  CAR_SUSPENDED
  BOOKING_CANCELLED
  BOOKING_REFUNDED
  PAYOUT_PROCESSED
  SETTINGS_UPDATED
}

enum Transmission {
  AUTOMATIC
  MANUAL
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
  LPG
}

enum CarCategory {
  ECONOMY
  COMPACT
  SEDAN
  SUV
  LUXURY
  SPORTS
  VAN
  MINIVAN
  PICKUP
  CONVERTIBLE
}

enum CarStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentType {
  BOOKING
  DEPOSIT
  EXTRA_FEES
  REFUND
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReviewType {
  CAR_REVIEW
  RENTER_REVIEW
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_COMPLETED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  REVIEW_RECEIVED
  MESSAGE_RECEIVED
  CAR_APPROVED
  CAR_REJECTED
  PAYOUT_SENT
  SYSTEM
}

model Report {
  id         String       @id @default(uuid())
  reporterId String
  reportedId String
  type       ReportType
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  reporter User @relation("ReportedBy", fields: [reporterId], references: [id])

  @@index([reporterId])
  @@index([type, reportedId])
}

enum ReportType {
  USER
  CAR
  BOOKING
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}
